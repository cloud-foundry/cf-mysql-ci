---
resources:
- name: aws-stemcell
  type: bosh-io-stemcell
  source:
    name: bosh-aws-xen-hvm-ubuntu-trusty-go_agent

- name: deployments-scripts
  type: git
  source:
    uri: {{deployments_oss_config_repo_uri}}
    private_key: {{git-private-key}}

- name: deployments-configuration
  type: git
  source:
    uri: {{deployments_config_repo_uri}}
    private_key: {{git-private-key}}

- name: cf-mysql-release-rc
  type: git
  source:
    uri: git@github.com:cloudfoundry/cf-mysql-release
    branch: release-candidate
    private_key: {{git-writer-private-key}}

- name: aws-acceptance-environment
  type: pool
  source:
    uri: git@github.com:pivotal-cf-experimental/core-services-oss-env-resource-pool
    branch: master
    pool: aws-acceptance
    private_key: {{git-writer-private-key}}

- name: acceptance-deployment
  type: bosh-deployment
  source:
    target: {{acceptance_env_bosh_url}}
    username: {{acceptance_env_bosh_username}}
    password: {{acceptance_env_bosh_password}}
    deployment: {{acceptance_env_deployment_name}}
    ignore_ssl: true

jobs:
- name: claim-aws-environment
  plan:
  - aggregate:
    - get: cf-mysql-release
      resource: cf-mysql-release-rc
      trigger: true
    - put: aws-acceptance-environment
      params:
        acquire: true

- name: delete-acceptance-deployment
  plan:
  - aggregate:
    - get: aws-acceptance-environment
      passed: [claim-aws-environment]
    - get: cf-mysql-release
      resource: cf-mysql-release-rc
      passed: [claim-aws-environment]
      trigger: true
    - get: deployments-scripts
    - get: deployments-configuration
  - task: run-broker-deregistrar
    config:
      platform: linux
      image: docker:///cloudfoundry/cf-mysql-ci
      inputs:
        - name: deployments-scripts
        - name: deployments-configuration
      params:
        ENV: {{acceptance_env_name}}
        DEPLOYMENT_NAME: {{acceptance_env_deployment_name}}
        BOSH_USER: {{acceptance_env_bosh_username}}
        BOSH_PASSWORD: {{acceptance_env_bosh_password}}
        DEPLOYMENTS_DIR: deployments-configuration
      run:
        path: deployments-scripts/scripts/run_errand_broker_deregistrar
  - task: delete-acceptance-deployment
    config:
      platform: linux
      image: docker:///cloudfoundry/cf-mysql-ci
      inputs:
        - name: deployments-scripts
        - name: deployments-configuration
      params:
        ENV: {{acceptance_env_name}}
        DEPLOYMENT_NAME: {{acceptance_env_deployment_name}}
        BOSH_USER: {{acceptance_env_bosh_username}}
        BOSH_PASSWORD: {{acceptance_env_bosh_password}}
        DEPLOYMENTS_DIR: deployments-configuration
      run:
        path: deployments-scripts/scripts/delete_deployment

- name: deploy-to-acceptance
  plan:
  - aggregate:
    - get: deployments-scripts
    - get: deployments-configuration
    - get: cf-mysql-release
      resource: cf-mysql-release-rc
      passed: [delete-acceptance-deployment]
      trigger: true
    - get: aws-stemcell
    - get: aws-acceptance-environment
      passed: [delete-acceptance-deployment]
  - aggregate:
    - task: create-release
      config:
        platform: linux
        image: docker:///cloudfoundry/cf-mysql-ci
        inputs:
        - name: deployments-scripts
        - name: cf-mysql-release
        params:
          RELEASE_RELATIVE_DIR: cf-mysql-release/
          BOSH_USER: {{acceptance_env_bosh_username}}
          BOSH_PASSWORD: {{acceptance_env_bosh_password}}
        run:
          path: deployments-scripts/scripts/create_release_cf_mysql_release
    - task: make-manifest
      config:
        platform: linux
        image: docker:///cloudfoundry/cf-mysql-ci
        inputs:
        - name: deployments-scripts
        - name: deployments-configuration
        - name: cf-mysql-release
        params:
          ENV: {{acceptance_env_name}}
          BOSH_USER: {{acceptance_env_bosh_username}}
          BOSH_PASSWORD: {{acceptance_env_bosh_password}}
          DEPLOYMENTS_DIR: deployments-configuration
        run:
          path: deployments-scripts/scripts/make_manifest_cf_mysql
  - put: acceptance-deployment
    params:
      manifest: make-manifest/cf-mysql-release/deployment.yml
      releases: [create-release/cf-mysql-release/dev_releases/cf-mysql/*.tgz]
      stemcells: [aws-stemcell/*.tgz]

- name: run-smoke-tests-acceptance
  plan:
  - aggregate:
    - get: aws-acceptance-environment
      passed: [deploy-to-acceptance]
    - get: cf-mysql-release
      resource: cf-mysql-release-rc
      passed: [deploy-to-acceptance]
      trigger: true
    - get: deployments-scripts
    - get: deployments-configuration
  - task: run-broker-registrar
    config:
      platform: linux
      image: docker:///cloudfoundry/cf-mysql-ci
      inputs:
        - name: deployments-scripts
        - name: deployments-configuration
      params:
        ENV: {{acceptance_env_name}}
        DEPLOYMENT_NAME: {{acceptance_env_deployment_name}}
        BOSH_USER: {{acceptance_env_bosh_username}}
        BOSH_PASSWORD: {{acceptance_env_bosh_password}}
        DEPLOYMENTS_DIR: deployments-configuration
        ERRAND: broker-registrar
      run:
        path: deployments-scripts/scripts/run_errand
  - task: run-smoke-tests
    config:
      platform: linux
      image: docker:///cloudfoundry/cf-mysql-ci
      inputs:
        - name: deployments-scripts
        - name: deployments-configuration
      params:
        ENV: {{acceptance_env_name}}
        DEPLOYMENT_NAME: {{acceptance_env_deployment_name}}
        BOSH_USER: {{acceptance_env_bosh_username}}
        BOSH_PASSWORD: {{acceptance_env_bosh_password}}
        DEPLOYMENTS_DIR: deployments-configuration
        ERRAND: acceptance-tests
      run:
        path: deployments-scripts/scripts/run_errand

- name: release-acceptance-environment
  plan:
  - aggregate:
    - get: cf-mysql-release
      resource: cf-mysql-release-rc
      passed: [run-smoke-tests-acceptance]
      trigger: true
    - get: aws-acceptance-environment
      passed: [run-smoke-tests-acceptance]
  - put: aws-acceptance-environment
    params:
      release: aws-acceptance-environment
