#!/bin/bash

set -eux

my_dir="$( CD "$( DIRNAME "${BASH_SOURCE[0]}" )" && PWD )"
ci_dir="$( CD "${my_dir}/../../" && pwd )"
WORKSPACE_DIR="$( cd "${ci_dir}/../" && pwd )"

source "${ci_dir}/scripts/utils.sh"

: "${ENV_TARGET_FILE:?}"
: "${ENV_METADATA:?}"
: "${ERRAND:?}"
: "${DEPLOYMENT_NAME:?}"

BOSH_ENVIRONMENT="$(cat "${ENV_TARGET_FILE}")"
BOSH_ENVIRONMENT="$(ssl_from_ip "${BOSH_ENVIRONMENT}")"
ENV_SHORT_NAME="$(jq_val "env" "${ENV_METADATA}")"

BOSH_USER="$(jq_val "bosh_user" "${ENV_METADATA}")"
BOSH_PASSWORD="$(jq_val "bosh_password" "${ENV_METADATA}")"
BOSH_CA_CERT=${BOSH_CA_CERT_PATH?-"${WORKSPACE_DIR}/${ENV_REPO}/${ENV_SHORT_NAME}/certs/rootCA.pem"}
BOSH_DEPLOYMENT="${DEPLOYMENT_NAME}"

gobosh \
    -n \
    run-errand \
    "${ERRAND}"
