#!/bin/bash

set -eux

my_dir="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
workspace_dir="$( cd "${my_dir}/../../../" && pwd )"
cd ${workspace_dir}

bosh int \
    ./cf-deployment/cf-deployment.yml \
    --vars-store ./varstore/deployment-vars.yml \
    -v system_domain="$(cat "./url/url")" \
    -v proxy_vm_extension=mysql-proxy-lb \
    -o ./cf-deployment/operations/use-compiled-releases.yml \
    -o ./cf-deployment/operations/bosh-lite.yml \
    -o ./cf-deployment/operations/scale-database-cluster.yml \
    -o ./pxc-release/operations/cf-deployment-use-pxc.yml \
    -o ./pxc-release/operations/enable-remote-admin-access.yml \
    -o ./pxc-release/operations/proxy-elb.yml \
    > ./cf-deployment-manifest/cf.yml
