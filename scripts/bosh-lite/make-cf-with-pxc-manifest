#!/bin/bash

set -eux

: "${PROXY_LB:=false}"
: "${MIGRATE:=false}"

my_dir="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
workspace_dir="$( cd "${my_dir}/../../../" && pwd )"
cd ${workspace_dir}

extras=""

if ${PROXY_LB}; then
    extras="$extras -v vm_extension=mysql-proxy-lb"
    extras="$extras -o ./cf-mysql-ci/operations/cf-deployment/add-database-vm-extension.yml"
fi

if ${MIGRATE}; then
    extras="$extras -o ./pxc-release/operations/migrate-cf-deployment-to-pxc.yml"
else
    extras="$extras -o ./cf-deployment/operations/scale-database-cluster.yml"
    extras="$extras -o ./pxc-release/operations/cf-deployment-use-pxc.yml"
fi

bosh int \
    ./cf-deployment/cf-deployment.yml \
    --vars-store ./varstore/deployment-vars.yml \
    -o ./cf-deployment/operations/use-compiled-releases.yml \
    -o ./cf-deployment/operations/bosh-lite.yml \
    -v system_domain="$(cat "./url/url")" \
    -v proxy_route_suffix="p-mysql.$(cat "./url/url")"
    ${extras} \
    -o ./cf-mysql-ci/operations/cf-deployment/enable-remote-admin-access.yml \
    > ./cf-deployment-manifest/cf.yml
