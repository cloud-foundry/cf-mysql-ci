#!/bin/bash
set -eux

bosh-ip() {
  bosh -n vms cf-warden-mysql | grep $1 | awk '{ print $8 }'
}

set_env(){
  MY_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
  CI_DIR="$( cd "${MY_DIR}/../../" && pwd )"
  WORKSPACE_DIR="$( cd "${CI_DIR}/.." && pwd )"

  source "${CI_DIR}/scripts/utils.sh"

  : "${BOSH_LITE_SSH_KEY:?}"
  : "${ENV_TARGET_FILE:?}"
  : "${ENV_METADATA:?}"

  BOSH_TARGET=$(cat "${ENV_TARGET_FILE}")

  BOSH_USER="$(jq_val "bosh_user" "${ENV_METADATA}")"
  BOSH_PASSWORD="$(jq_val "bosh_password" "${ENV_METADATA}")"

  bosh -n target "${BOSH_TARGET}"
  bosh -n login "${BOSH_USER}" "${BOSH_PASSWORD}"
}

stop_all_nodes() {
  pushd "${WORKSPACE_DIR}"
    # assumes we are running against a remote bosh-lite
    BOSH_LITE_KEY_FILE="/tmp/id_rsa"
    echo "${BOSH_LITE_SSH_KEY}" > "${BOSH_LITE_KEY_FILE}"
    chmod 600 "${BOSH_LITE_KEY_FILE}"

    for nodeIndex in $(seq 1 3); do
      MYSQL_NODE=$(bosh-ip "mysql_z${nodeIndex}/0")
      ssh \
          -t \
          -i "${BOSH_LITE_KEY_FILE}" \
          -o StrictHostKeyChecking=no \
          "ubuntu@${BOSH_TARGET}" \
          "curl -vk -X POST username:password@${MYSQL_NODE}:9200/stop_mysql"
    done
  popd
}

main(){
    set_env
    stop_all_nodes
}

main
