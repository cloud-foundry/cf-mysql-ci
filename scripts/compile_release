#!/bin/bash

set -eux

MY_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
WORKSPACE_DIR="$( cd "${MY_DIR}/../.." && pwd )"
OUTPUT_DIR="${WORKSPACE_DIR}/${OUTPUT_DIR:-compiled-release-tarball}"
DEPLOYMENT_NAME=d-$(cat /proc/sys/kernel/random/uuid)

RELEASE_TARBALL_DIR=${RELEASE_TARBALL_DIR:-release-tarball}
RELEASE_FILENAME=${RELEASE_FILENAME:-tgz}
RELEASE_FILE=$(ls ${RELEASE_TARBALL_DIR}/ | grep ${RELEASE_FILENAME})
if [ -f "${RELEASE_TARBALL_DIR}/version" ]; then
  RELEASE_MANIFEST=$(tar -zxOf "${WORKSPACE_DIR}/${RELEASE_TARBALL_DIR}/${RELEASE_FILE}" ./release.MF)
  RELEASE_NAME=$(echo "$RELEASE_MANIFEST" | grep "^name:" | sed 's/name: \(.*\)/\1/')
  RELEASE_VERSION=$(echo "$RELEASE_MANIFEST" | grep "^version:" | sed 's/version: \(.*\)/\1/')
else
  RELEASE_NAME=$(echo ${RELEASE_FILE} | sed 's/\(.*\)-[0-9].*/\1/')
  RELEASE_VERSION=$(echo ${RELEASE_FILE} | sed 's/.*-\([0-9].*\).tgz/\1/')
fi

# egrep for pivnet-resource stemcells that will have the etag after the version
STEMCELL_VERSION=$(cat *stemcell/version | egrep -o '^[1-9.]+')

pushd "${WORKSPACE_DIR}"
  cat << EOF > deployment.yml
---
name: ${DEPLOYMENT_NAME}

director_uuid: 28dc9bd9-c145-4048-b4b1-7e3582a51e9f

releases:
- name: ${RELEASE_NAME}
  version: "${RELEASE_VERSION}"
  url: "file://${WORKSPACE_DIR}/${RELEASE_TARBALL_DIR}/${RELEASE_FILE}"

stemcells:
- alias: default
  os: ubuntu-trusty
  version: ${STEMCELL_VERSION}

jobs: []

update:
  canaries: 1
  max_in_flight: 1
  canary_watch_time: 1000-90000
  update_watch_time: 1000-90000
EOF
  echo "Targeting ${BOSH_DIRECTOR}"
  set +x
    bosh -u ${BOSH_USERNAME} -p ${BOSH_PASSWORD} target ${BOSH_DIRECTOR}
    bosh login ${BOSH_USERNAME} ${BOSH_PASSWORD}
  set -x

  bosh deployment deployment.yml
  bosh upload stemcell *stemcell/*.tgz --skip-if-exists
  bosh -n deploy

  bosh export release ${RELEASE_NAME}/${RELEASE_VERSION} ubuntu-trusty/${STEMCELL_VERSION}

  mv release*.tgz ${OUTPUT_DIR}/

  bosh -n delete deployment ${DEPLOYMENT_NAME}
popd
